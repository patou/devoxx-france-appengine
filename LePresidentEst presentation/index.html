<!DOCTYPE html>

<!--
  Google HTML5 slide template

  Authors: Luke Mahé (code)
           Marcin Wichary (code and design)
           
           Dominic Mazzoni (browser compatibility)
           Charles Chen (ChromeVox support)

  URL: http://code.google.com/p/html5slides/
-->

<html>
  <head>
    <title>Le président est...</title>

    <meta charset='utf-8'>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src='slides.js'></script>
    <script type="text/javascript" src="jsmove.js" ></script>
  </head>
  
  <style>
    /* Your individual styles here, or just use inline styles if that’s
       what you want. */
    .slide3d.end
	{
		-webkit-transform: rotateY(175deg) rotateX(-5deg) translateZ(-50px) !important;
		-webkit-transition: 1s;
	}
	.bookparagraph
	{
		text-align: justify;
		text-indent: 1.5em;
	}
	
	.slide3d
	{
		position: absolute;
		top: 0px;
		left: 0px;
		width: 100%;
		height: 100%;
		-webkit-transform-style: preserve-3d;
		overflow: visible !important; /* bug with overflow=hidden and 3D  */
	}

	.backslide3d
	{
		position: absolute;
		width: 98%;
		height: 98%;
		top: 1%;
		left: 1%;
		opacity: 0.97;
		background-color: white;
		-webkit-transform-style: preserve-3d;
		-webkit-transform: rotateY(180deg) translateZ(5px);
	}
    
    table.table-noborders tr td
    {
    	border: none;
    	padding: 0;
    	margin: 0;
    }
    
    table.table-noborders
    {
    	margin:0;
    }
    
    .pop
    {
    	color: black;
    	font-weight: bold;
    }
    .poplow
    {
    	color: black;
    }
    .popact
    {
    	color: black;
    	font-style: oblique;
    }
    .big
    {
    	font-size: larger;
    	line-height: 1.1em;
    }
    .small
    {
    	font-size: smaller;
    	line-height: 1.1em;
    }
    .x-small
    {
    	font-size: 0.7em;
    	line-height: 1em;
    }
    .jsp
    {
    	color: red !important;
    	font-family: monospace;
    }
    H3.info
    {
    	background-image: url('images/info.png');
    	background-repeat: no-repeat;
    	background-position: 100% 0%;
    	min-height: 80px;
    }
    article.info
    {
    	background-color: #F8FAFF !important;
    }
    .screenshot-left
    {
    	float:left;
    	margin-right:60px;
    	margin-top:10px;
		margin-bottom:10px;
		margin-left:10px;
		padding: 10px;
		border:1px solid #EEEEEE;
		box-shadow: 3px 3px 8px #AAAAAA;
    }
    pre.lesspace
    {
    	margin-top: 15px;
    	margin-bottom: 25px;
    }
    .smallcode
    {
    	font-size: 0.54em;
    	line-height: 1.4em;
    }
    .x-smallcode
    {
    	font-size: 0.49em;
    	line-height: 1.3em;
    }
    .u
    {
    	text-decoration: underline;
    }
  </style>

  <body style='display: none; '>

    <section class='slides layout-regular template-default' style="-webkit-perspective: 1000px;">
      
      <!-- Your slides (<article>s) go here. Delete or comment out the
           slides below. -->

<!-- ------------------------------------------------------------------------------- -->
<!-- Page de titre -->
	<style>
		
		div#candidats
		{
			position: absolute;
			width: 100%;
			top: 50px;
			-webkit-transform: translateZ(-80px);
		}
		div#candidats img
		{
			margin: 20px;
		}
		div.qmark
		{
			font-size: 7em;
			position: absolute;
			color: rgb(200,200,200);
			
			-webkit-transform:  translateZ(-200px) rotateY(180deg);
		}
		div.qmark#q1 { top: 260px; left: 240px; }
		div.qmark#q2 { top: 280px; left: 680px; }
		div.qmark#q3 { top: 270px; left: 460px; }
		
	</style>
	<article id="art1" onclick="move('art1')" class="slide3d">
	<div class="backslide3d"></div>
	
	 <div style="position: absolute; top: 30px; left: 520px; -webkit-transform:  translateZ(5px)"><img style="width:350px" src="images/appengine.png" /></div>
	 <h1>
	   Le président est...
	 </h1>
	 &nbsp;
	 <h3>
	   Un exercice de style et de montée en charge <br/>sur App Engine
	 </h3>
	 <p style="font-size: 0.75em; margin-top: 140px;">
	   Didier Girard, Ludovic Champenois, Martin Görner, Patrice de Saint Steban<br/>
	 </p>
	  
	  <!-- on the other side -->
		<div id="candidats">
		  <img src="images/sarkozy.png" />
		  <img src="images/hollande.png" />
		  <img src="images/joly.png" />
		  <img src="images/lepen.png" />
		  <img src="images/bayrou.png" />
		  <img src="images/melenchon.png" />
		</div>
		<div class="qmark" id="q1">?</div>
		<div class="qmark" id="q2">?</div>
		<div class="qmark" id="q3">?</div>
	</article>

	<article id="art1bis" onclick="move('art1bis')" class="slide3d">
	<div class="backslide3d">
	<img src="images/appengine.png" style="width:175px; position:absolute; top:240px; left:340px; -webkit-transform:translateZ(200px)"/>
	 
	<p style="margin:30px">
		Pour ceci vous disposez d'une plateforme, AppEngine et d'experts pour vous guider.
	</p>
	 <p style="margin:30px">
		Le défi est à relever en 3 heures seulement.
	 </p>
	 
	 <p class="pop" style="font-size: larger; text-align: center; margin-top:200px;">
		Prêt à relever le défi ?
	 </p>
         
         <p>
            Pr&eacute;-requis: 
         </p>
         <p style="font-size: 75%">
            &bull; <a href="http://www.oracle.com/javase">JDK 6</a> (pas JRE)
            <br/>&bull; <a href="http://eclipse.org">Eclipse 3.7</a> (Indigo, JEE version)
            <br/>&bull; <code>Google Plugin for Eclipse 3.7</code> et <code>Google App Engine Java SDK 1.6.4</code>
            <br/>disponibles depuis le r&eacute;f&eacute;rentiel <a href="http://dl.google.com/eclipse/plugin/3.7">http://dl.google.com/eclipse/plugin/3.7</a>
            <br/>&bull; un compte <a href="http://gmail.com">gmail.com</a> (pour la partie identification)

         </p>

	</div>

		<p class="bookparagraph">
		Vous venez de gagner un contrat. Il s'agit de développer le site web qui va annoncer au soir du <strong>6 mai 2012</strong> le nouveau président de la République Française.
		</p>
		<p class="bookparagraph">
		Le site devra pouvoir accueillir un traffic potentiel maximum de <strong>50 millions d'utilisateurs</strong> le 6 mai. Ce jour là, un pic à <strong>2 millions d'utilisateurs</strong> simultanés est attendu a 20h. Ensuite, le 7 mai <strong>1 million</strong> d'utilisateurs viendront et les jours suivants quelques milliers d'utilisateurs au grand maximum. Le site devra proposer des fonctions de type social : vote de satisfaction, commentaires, publications d'images, ...
		</p>
		<p class="pop big" style="margin-top: 20px; text-align: center">
		   Il ne doit pas faire défaut, il n'est pas concevable qu'il tombe a l'heure H.
		</p>
	</article>	
	  
<!-- ------------------------------------------------------------------------------- -->
<!-- 1. Ma première servlet "Hello App Engine" -->

	  <article id="art2" onclick="move('art2')" class="slide3d" > 
      <div class="backslide3d">
<p>
	Structure du projet Web :
</p>	
<br/>
<img  src="images/project_structure.png" align="left"/>
	
<p>
En utilisant l'assistant pour créer la servlet, le fichier standard <code>web.xml</code> est mis à jour pour effectuer le mapping de celle-ci. 
</p>

<p>
Le fichier <code>appengine-web.xml</code> contient des valeurs par défaut et sera utilisé plus tard pour spécifier un nom et une version d'application et d'autres <a href="https://developers.google.com/appengine/docs/java/config/appconfig">paramètres optionels propres à AppEngine</a>.
</p>

<p>
<h3>
	Problème?
</h3>

 	En cas re-déploiement si vous rencontrez une erreur de type <code>"port occupied"</code>, il vous faudra utiliser le bouton rouge "Terminate" dans le haut de la fenêtre <code>"Console"</code> (Window &gt; Show View &gt; Console).
<img  src="images/stop_server.png"/>

		
	<!--
<p>fichier: src/com/moi/lepresident/LePresidentServlet.java</p>
<pre>
package com.moi.lepresident;

import java.io.IOException;
import javax.servlet.http.*;

@SuppressWarnings("serial")
public class LePresidentServlet extends HttpServlet
{
    public void doGet(HttpServletRequest req, HttpServletResponse resp)
    throws IOException
    {
        resp.setContentType("text/plain");
        resp.getWriter().println("Hello, App Engine");
    }
}
</pre>
-->
      </div>

        <h3>
          1. Ma première servlet "Hello App Engine"
        </h3>
        <ul style="margin-top:20px">
        <li>File &gt; New ... &gt; <img style="height:30px; vertical-align:bottom;" src="images/webappproj.png" /></li>
        <li>Nom: <span class="pop">LePresident</span>, package: <span class="pop">com.moi.lepresident</span></li>
        <li><form>Décocher <input type="checkbox" style="vertical-align: middle;" disabled="disabled"/><span class="pop">GWT</span> (pour aujourd'hui), Cocher <input type="checkbox" checked style="vertical-align: middle;" disabled="disabled"/><span class="pop">App Engine</span></form></li>
        <li>"Finish" pour générer le projet puis autoriser le <span class="pop">multi-threading&nbsp;!</span> (dans war/WEB-INF/appengine-web.xml)</li>
        <li>Personnaliser la servlet: par exemple <span class="pop">"Hello App Engine"</span><br/>(dans src/com/moi/lepresident/LePresidentServlet.java)</li>
        <li>Lancer en local: Run &gt; Run As... &gt; <img style="height:30px; vertical-align:bottom;" src="images/webapp.png" /><br/>
        <span class="small" style="color: red; font-family: monospace;">INFO: The server is running at <a style="color: red;" target="_blank" onclick="noop()" href="http://localhost:8888/">http://localhost:8888/</a></span></li>
        <li class="small">Puis rajouter la <a href="http://code.google.com/p/objectify-appengine/downloads/list?q=label:Featured" target="_blank" onclick="noop()">librairie objectify</a>: (1) glisser-déplacer objectifyxxx.jar sur war/WEB-INF/lib. (2) La référencer dans les propriétés du projet, "Java Build Path", onglet "Libraries", bouton "Add JARs..."</li>
        </ul>


      </article>

<!-- ------------------------------------------------------------------------------- -->
<!-- Passons en JSP -->

	  <article id="art3" onclick="move('art3')" class="info slide3d">
	  <div class="backslide3d"></div>
        <h3 class="info">
          Passons en JSP.<br/>JSP c'est comme du HTML, mais on peut:
        </h3>
        <ul style="margin-top:100px">
          <li>exécuter du code java entre <span class="pop" style="font-family: monospace;"><span style="color:red">&lt;%</span> ...code java... <span style="color:red">%&gt;</span></span>
          <li>afficher une valeur via <span class="pop" style="font-family: monospace;"><span style="color:red">&lt;%=</span> truc.getMachin() <span style="color:red">%&gt;</span></span>
          <li>avoir accès aux objets JSP suivants: <span style="font-family: monospace;" >HttpServletRequest <span class="pop">request</span>, HttpServletResponse <span class="pop">response</span>, JspWriter <span class="pop">out</span></span>
        </ul>
        <p class="small" style="margin-top: 110px;">(Dans le futur, pour écrire du code propre, préférez GWT.)</p>
      </article>
     
<!-- ------------------------------------------------------------------------------- -->
<!-- 3. Votre premier JSP -->

	  <article id="art4" onclick="move('art4')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: war/index.jsp</p>
<pre>
&lt;! DOCTYPE html&gt;
&lt;%@ page contentType="text/html;charset=UTF-8" language="java" <span style="color:grey">%&gt;</span>
&lt;html&gt;
  &lt;head&gt;&lt;title&gt;Le président est ...&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
    &lt;H1&gt;Le président est ...&lt;/H1&gt;
    &lt;img src="sarkozy.png"&gt;
    &lt;p&gt;&lt;%=request.getProtocol() <span style="color:grey">%&gt;</span>&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>On peut configurer cette page comme page par défaut dans war/WEB-INF/web.xml</p>
<p>Vous trouverez les photos des candidats derrière la première diapositive.</p>
      </div>
        <h3>
          2. Ajouter une page index.jsp qui affiche par exemple:
        </h3>
        
        <div style="margin-top:70px;">
        <div class="screenshot-left">
        <img  src="images/scrshot1.png"/>
        </div>
        <p>&nbsp;<br/>&nbsp;<br/>On n'a pas encore le nom de l'élu alors faute de mieux on affiche le protocole en utilisant:</p>
        <pre>request.getProtocol()</pre>
        </div>

      </article>

<!-- ------------------------------------------------------------------------------- -->
<!-- 3. Ajouter un formulaire et sa réponse -->

	  <article id="art5" onclick="move('art5')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: war/index.jsp</p>
<pre style="margin-bottom:10px" class="smallcode">
&lt;! DOCTYPE html&gt;
&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
&lt;%@ page import="com.google.appengine.repackaged.com.google.common.xml.XmlEscapers" %&gt;
&lt;html&gt;
  &lt;body&gt;
    &lt;H1&gt;Le président est ...&lt;/H1&gt;
    &lt;img src="sarkozy.png" /&gt;
    &lt;% 
        String comment = request.getParameter("user-comment");
        if (comment != null)
            comment = XmlEscapers.xmlContentEscaper().escape(comment);
    %&gt;
    &lt;p&gt;Vous: &lt;%= comment %&gt;&lt;/p&gt;
    &lt;form action="" method="post"&gt;
         &lt;textarea name="user-comment" &gt;&lt;/textarea&gt;&lt;br/&gt;
         &lt;input type="submit" value="c'est mon avis" /&gt;
     &lt;/form&gt; 
  &lt;/body&gt;
&lt;/html&gt;
</pre>
ATTENTION aux vulnérabilités XSS! Ne jamais insérer dans une page du texte en provenance d'un utilisateur sans escaping.
      </div>
        <h3>
          3. Ajouter un champ de commentaire - sans persistence pour l'instant
        </h3>
        
        <div style="margin-top:20px;">
        <div class="screenshot-left">
        <img  src="images/scrshot2.png"/>
        </div>
        <p>Il vous faut une zone de saisie:</p>
<pre>
&lt;form action="" method="post"&gt;
   &lt;textarea name="user-comment" /&gt;
   &lt;input type="submit"
         value="c'est mon avis" /&gt;
&lt;/form&gt; 
</pre>
		<p>Et la fonction qui donne la valeur d'un paramètre de requête:</p>
<pre>
request.getParameter("user-comment")
</pre>
        </div>
      </article>
      
<!-- ------------------------------------------------------------------------------- -->
<!-- 4. Identifier l'utilisateur par son compte Google-->

	  <article id="art6" onclick="move('art6')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: war/index.jsp</p>
<pre class="x-smallcode">
&lt;! DOCTYPE html&gt;
&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
&lt;%@ page import="com.google.appengine.repackaged.com.google.common.xml.XmlEscapers" %&gt;
<span class="u">&lt;%@ page import="com.google.appengine.api.users.*" %&gt;</span>

&lt;html&gt;&lt;body&gt;
    &lt;H1&gt;Le président est ...&lt;/H1&gt; &lt;img src="sarkozy.png" /&gt;
&lt;%
    <span class="u">UserService userService = UserServiceFactory.getUserService();</span>
    <span class="u">User user = userService.getCurrentUser();</span>
    <span class="u">if (user == null)</span>
    {%&gt;
        &lt;p&gt;Bonjour, &lt;a href="&lt;%= <span class="u">userService.createLoginURL(request.getRequestURI())</span> %&gt;"&gt;
        identifiez-vous&lt;/a&gt; pour pouvoir commenter l'élection.&lt;/p&gt;
    &lt;%}
    else
    {
        String comment = request.getParameter("user-comment");
        if (comment != null)
            comment = XmlEscapers.xmlContentEscaper().escape(comment);
%&gt;
        &lt;p&gt;&lt;b&gt;&lt;%=<span class="u">user.getNickname()</span>%&gt;:&lt;/b&gt; &lt;%=comment%&gt;&lt;/p&gt;
    
        &lt;form action="" method="post"&gt;
            &lt;textarea name="user-comment"&gt;&lt;/textarea&gt;&lt;br/&gt;
            &lt;input type="submit" value="c'est mon avis" /&gt;
            &lt;!-- lien de déconnexion --&gt;
            &lt;a href="&lt;%= <span class="u">userService.createLogoutURL(request.getRequestURI())</span> %&gt;"&gt;déconnexion&lt;/a&gt;
        &lt;/form&gt;
&lt;% } %&gt;
&lt;/body&gt;&lt;/html&gt;
</pre>
      </div>
        <h3>
          4. Identifier l'utilisateur par son compte Google
        </h3>
        
        <div style="margin-top:20px;">
        <div class="screenshot-left">
        <img  src="images/scrshot3.png"/>
        </div>
        <p>Utiliser le <span class="pop">UserService</span> d'App Engine</p>
<pre class="smallcode">
UserService userService =
   UserServiceFactory.getUserService();
User user = userService.getCurrentUser();
String n = user.getNickname();
String e = user.getEmail();

</pre>

		<p>Il vous fournit aussi les URLs de connexion et déconnexion:</p>
<pre class="smallcode">
userService.createLoginURL("myTargetURL")
userService.createLogoutURL("myTargetURL");
</pre>
        </div>
      </article>
 
<!-- ------------------------------------------------------------------------------- -->
<!-- datastore explanation -->

      <article id="art6b" onclick="move('art6b')" class="slide3d info" >
	<p>
		
	</p>
	<div class="backslide3d">
	</div>
      <h3 class="info">High Replication Datastore:<br/>réplication, accès simultanés, montée en charge</h3>
		<img style="float: left; padding: 10px; margin-right: 25px; margin-top: 15px; background-color: white; border: 1px solid grey" height="420px" src="images/datastore.svg" />        
        <p style="margin-top: 50px;">Organisation à peu près comme en XML.</p>
        <p>Requêtes indexées uniquement.</p>
        <p>Cohérence à terme des lectures et écritures.</p>
        <p class="poplow">Entity = kind + <br/>(multivalued) properties + key</p>
        
      </article>
      
<!-- ------------------------------------------------------------------------------- -->
<!-- architecture explanation -->
<style>
	.archimage
	{
		
		width:266px;
		display:inline-block;
		vertical-align: top;
		text-align: center;
	}
	.archtext
	{
		display:inline-block;
		width:180px;
		text-align: right;
		color: black;
		font-style: italic;
	}
	.newarchimage
	{
		width: 300px;
		border:1px grey solid;
		background-color: white
	}
</style>
    <article id="art6c" onclick="move('art6c')" class="slide3d info" >
	<div class="backslide3d">
	</div>
      <h3 class="info">Architecture d'application sur App Engine</h3>
      
		<div class="archimage">
			<div style="border:#b4a464 inset 8px;background-color: #f1e9db;">“système 2000”<br/><img src="images/oldarch.png" width="250px"/>
			    <div class="x-small" style="padding: 5px; ">
			         session en RAM avec<br/>
			         sticky load balancer
			     </div>
			 </div>
			 <div class="small" style="text-align: left; margin-top: 5px">
			     <span class="pop">☠</span> pb sur arrêt d'instance<br/>
			     <span class="pop">☠</span> mémoire insuffisante<br/>
			     <span class="pop">☠</span> load balancing lent<br/>
			     <span class="pop">☠</span> pb scalabilité base<br/>
			     
			</div>
			</div>
		<div class="archtext small">
		    <div style="margin-top:47px;">datastore→</div>
		    <div  style="margin-top:30px;">memcache→</div>
		    <div  style="margin-top:80px;">frontends→</div>
		    <div  style="margin-top:80px;">load balancing efficace→</div>
		</div>
		<div class="archimage newarchimage">App Engine<br/><img src="images/newarch.png" width="300px"/>
		<div class="x-small" style="padding: 5px; ">instances stateless, état dans memcache et datastore</div>
		</div>
        
      </article>
      
<!-- ------------------------------------------------------------------------------- -->
<!-- 5. Conserver les commentaires sur le serveur. -->

	  <article id="art7" onclick="move('art7')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: src/com/moi/lepresident/StoredComments.java</p>
<pre class="x-smallcode lesspace" style="margin-bottom: 15px;">
package com.moi.lepresident;
import java.util.*;
import com.google.appengine.api.datastore.*;
import com.google.appengine.api.datastore.Entity;

public class StoredComments {	
    static public void store(String text, String user) {
        Entity commentEntity = new Entity("Comment");
        commentEntity.setProperty("user", user);
        commentEntity.setProperty("date", new Date());
        commentEntity.setProperty("text", text);

        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();
        datastore.put(commentEntity);
    }
	
    static public List&lt;Entity&gt; retrieveAll() {
        DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();

        Query query = new Query("Comment");
        query.addSort("date", Query.SortDirection.DESCENDING);
        return datastore.prepare(query).asList(FetchOptions.Builder.withLimit(100));
    }
}
</pre>
Utilisation:
<pre class="x-smallcode lesspace" style="display:inline-block; margin-top:0px; vertical-align: top;">
// store:
StoredComments.store("Hello", "Nicolas");
// retrieve:
List&lt;Entity&gt; comments = StoredComments.retrieveAll();
for (Entity commentEntity: comments) { ... commentEntity.getProperty("text") ... }
</pre>
      </div>
        <h3>
          5. Conserver les commentaires sur le serveur. 
        </h3>
        
        <div style="margin-top:20px;">
        <div class="screenshot-left" style="margin-right: 45px;">
        <img  src="images/scrshot4.png"/>
        </div>
        <p>Accès bas niveau au datastore:</p>
<pre class="smallcode lesspace">
DatastoreService datastore =
 DatastoreServiceFactory.getDatastoreService();
</pre>
        <p>&Eacute;criture:</p>
<pre class="smallcode lesspace">
Entity commentEntity = new Entity("Comment");
commentEntity.setProperty("date", new Date());
commentEntity.setProperty("text", text);
datastore.put(commentEntity);
</pre>
        <p>Lecture: <span class="small">100 résultats triés par date</span></p>
<pre class="x-smallcode lesspace">
Query query = new Query("Comment");
query.addSort("date", Query.SortDirection.DESCENDING);
List&lt;Entity&gt; results =
   datastore.prepare(query)
      .asList(FetchOptions.Builder.withLimit(100));
</pre>

		
        </div>
      </article>

<!-- ------------------------------------------------------------------------------- -->
<!-- 6. Conserver les commentaires sur le serveur avec Objectify -->

	  <article id="art8" onclick="move('art8')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: src/com/moi/lepresident/ObjectifyDAO.java</p>
<pre class="x-smallcode lesspace">
package com.moi.lepresident;
import com.googlecode.objectify.ObjectifyService;     import com.googlecode.objectify.util.DAOBase;

public class ObjectifyDAO extends DAOBase
{ static { ObjectifyService.register(Comment.class); } }
</pre>
<p>fichier: src/com/moi/lepresident/Comment.java</p>
<pre class="x-smallcode lesspace">
package com.moi.lepresident;
import java.util.Date;     import javax.persistence.Id;     import com.googlecode.objectify.Query;

public class Comment
{
    @Id Long id;     Date date;     public String user;     public String text;

    public Comment() {}
    public Comment(String text, String user) { this.user = user; this.text = text; this.date = new Date(); }

    public static void store(String text, String user)
    {
        ObjectifyDAO dao = new ObjectifyDAO();
        dao.ofy().put(new Comment(text, user));
    }
    
    public static Query&lt;Comment&gt; retrieveAll()
    {
        ObjectifyDAO dao = new ObjectifyDAO();
        return dao.ofy().query(Comment.class).order("-date").limit(100);
    }
}
</pre>
      </div>
        <h3>
          6. La même chose avec Objectify. 
        </h3>
        
        <div style="margin-top:20px;">
        <div class="screenshot-left" style="margin-right: 45px; width:258px">
        Utiliser un POJO:
<pre class="smallcode lesspace">
public class Comment
{
    @Id Long id;
    Date date;
    String user;
    String text;

    public Comment() {}
    ...
}
</pre>
<p class="small">L'écriture en base génère l'id automatiquement si il est de type Long.</p>
        </div>
        <p>Enregistrement des classes et DAO:</p>
<pre class="x-smallcode lesspace">
public class ObjectifyDAO extends DAOBase
{
 static { ObjectifyService.register(Comment.class); }
}
// puis utiliser:
ObjectifyDAO dao = new ObjectifyDAO();
</pre>
        <p>&Eacute;criture:</p>
<pre class="smallcode lesspace">
dao.ofy().put(new Comment(text, user));
</pre>
        <p>Lecture: <span class="small">100 résultats triés par date</span></p>
<pre class="x-smallcode lesspace">
Query&lt;Comment&gt; query = dao.ofy().query(Comment.class)
                           .order("-date").limit(100);
for (Comment c: query) { ... }
</pre>

		
        </div>
      </article>
       
<!-- ------------------------------------------------------------------------------- -->  
<!-- Cron pour afficher le président actif -->
<!-- Afficher le président -->
      <article id="title7"> 
      		<h2>Afficher la photo du président à une heure fixe</h2>
      		<p>Utilisation de tâches planifiées</p>
      </article>

<!-- ------------------------------------------------------------------------------- -->
<!-- slide afficher l'image -->
	  <article id="art21" onclick="move('art21')" class="slide3d" > 
      <div class="backslide3d">
		<p>fichier: index.jsp</p>      
<pre class="x-smallcode lesspace" style="margin-bottom: 15px;">
 &lt;%
President president = President.getPresident();
if (president != null) {
%&gt;
 	&lt;img src="&lt;%= president.image %&gt;" /&gt;
 	&lt;h2&gt;&lt;%= president.name %&gt;&lt;/h2&gt;
&lt;% } else { %&gt;
 	&lt;img src="<a href="images/presidents.png">presidents.png</a>" /&gt;
	&lt;strong&gt;Le président ne sera annoncé qu'à partir du 6 mai 2012 à 20H00&lt;/strong&gt;
&lt;% } %&gt;
</pre>
<p>fichier: src/com/moi/lepresident/President.java</p>
<pre class="x-smallcode lesspace" style="margin-bottom: 15px;">
package com.moi.lepresident;
import javax.persistence.Id;
import com.googlecode.objectify.ObjectifyService;

public class President {
	@Id
	public Long id = null;
	public String name;
	public String image;
	public boolean active;

	public static President getPresident() {
		return new ObjectifyDAO().ofy().query(President.class)
			.filter("active", true).get();
	}
}
</pre>
</div>
        <h3>
          ?. Afficher sur la page d'accueil. 
        </h3>
        
        <div style="margin-top:15px;">
        <div class="screenshot-left" style="margin-right: 25px;">
        <img  src="images/scrshot_display_presidents.png" width="200px"/>
        </div>
        <p>Créez une entité President, avec un nom, l'url d'une image et un boolean qui indique si l'on doit afficher le président</p>
        <p>Si un président est actif, afficher sa photo et son image.</p>
<pre class="smallcode lesspace">
&lt;% President president = new Dao().ofy()
.query(President.class).filter("active", true).get(); %&gt;
&lt;img src="&lt;%= president.image %&gt;" /&gt;
&lt;h2&gt;&lt;%= president.name %&gt;&lt;/h2&gt;
</pre>
        <p>Sinon affichez une image par défaut et un message indiquant que le président ne sera annoncé qu'à partir du 6 mai à 20h00:</p>		
        </div>
      </article>
      
<!-- slide cron -->

      	  <article id="art22" onclick="move('art22')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: src/com/moi/lepresident/President.java</p>
<pre class="x-smallcode lesspace" style="margin-bottom: 15px;">
package com.moi.lepresident;
import java.io.IOException;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import com.googlecode.objectify.ObjectifyService;

public class CronServlet extends HttpServlet {
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		President president = new President();
		president.name = "Sarkozy";
		president.image = "/images/sarkozy.png";
		president.active = true;
		ObjectifyService.begin().put(president);
	}
}
</pre>
<p>Ajouter dans le fichier web.xml</p>
<pre class="smallcode lesspace">
&lt;servlet&gt;
	&lt;servlet-name&gt;CronServlet&lt;/servlet-name&gt;
	&lt;servlet-class&gt;com.moi.lepresident.CronServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
	&lt;servlet-name&gt;CronServlet&lt;/servlet-name&gt;
	&lt;url-pattern&gt;/ReleaseDate&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</pre>
      </div>
        <h3>
          ?. Créer la tâche planifié
        </h3>
        
        <div style="margin-top:20px;">
        <p>Créez une Servlet, qui crée une entité President et l'activez</p>
<pre class="smallcode lesspace">
President president = new President();
president.name = "Sarkozy";
president.image = "/images/sarkozy.png";
president.active = true;
ObjectifyService.begin().put(president);
</pre>
        <p>Mappez dans le web.xml, la servlet sur l'URL /ReleaseDate</p>
        <p>Testez la page en allant sur <a href="http://127.0.0.1:8888/ReleaseDate">http://127.0.0.1:8888/ReleaseDate</a></p>
        </div>
      </article>
 
 <!-- slide cron -->



      	  <article id="art23" onclick="move('art23')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: war/WEB-INF/cron.xml</p>
<pre class="smallcode lesspace">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;cronentries&gt;
  &lt;cron&gt;
    &lt;url&gt;/ReleaseDate&lt;/url&gt;
    &lt;schedule&gt;6 of may 20:00&lt;/schedule&gt;
    &lt;timezone&gt;Europe/Paris&lt;/timezone&gt;
  &lt;/cron&gt;
&lt;/cronentries&gt;
</pre>
<p>On indique la zone de décalage horaire à Paris, pour activer le président le 6 mai à 20h précise en France et non l'heure GMT !</p>
      </div>
        <h3>
          ?. Configurer le cron dans App Egnine
        </h3>
        
        <div style="margin-top:20px;">
        <p>La gestion des crons est simple dans Google AppEngine, il suffit de créer un fichier cron.xml dans WEB-INF et d'indiquer l'url de la tâche planifié, et la période de répétition</p>
        <p>Voici les balises XML à insérer :</p>
&lt;<strong>cronentries</strong>&gt;
<div style="margin-left: 20px;">
		&lt;<strong>cron</strong>&gt;
		<div style="margin-left: 20px;">
			<div>&lt;<strong>url</strong>&gt; Url de la tâche planifiée</div>
			<div>&lt;<strong>schedule</strong>&gt; Période de répétition (every days, 1 of jan,may 02:30, every 5 mins)</div>
			<div>&lt;<strong>timezone</strong>&gt; Zone décalage horaire</div>
		</div>
		&lt;/<strong>cron</strong>&gt;
</div>
&lt;/<strong>cronentries</strong>&gt;
        </div>
      </article>

<!-- ------------------------------------------------------------------------------- -->
<!-- slide Tasks Queue -->
      
      <article id="title8"> 
      		<h2>Ajouter deux compteurs +1/-1</h2>
      		<p>Utilisation de tâches</p>
      </article>

<!-- ------------------------------------------------------------------------------- -->
<!-- slide Upload -->
      
      <article id="title9"> 
      		<h2>Permettre l’upload d’une photo</h2>
      		<p>Envoi de photo, et stockage dans le datastore</p>
      </article>

<!-- ------------------------------------------------------------------------------- -->
<!-- Formulaire -->      
      <article id="art30" onclick="move('art30')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: admin.jsp</p>
<pre class="smallcode lesspace">
&lt;%@ page contentType="text/html;charset=UTF-8" language="java" %&gt;
&lt;%@page import="com.google.appengine.api.blobstore.BlobstoreServiceFactory"%&gt;

&lt;form action="&lt;%= BlobstoreServiceFactory.getBlobstoreService().createUploadUrl("/upload") %&gt;" 
	method="post" enctype="multipart/form-data"&gt;
    &lt;label&gt;Nom du président : &lt;/label&gt;&lt;input type="text" name="name" placeholder="le nom du candidat gagnant"/&gt;
    &lt;label&gt;Photo du président : &lt;/label&gt;&lt;input type="file" name="image"/&gt;
   	&lt;input type="submit" value="Envoyer"/&gt;
&lt;/form&gt;
</pre>
      </div>
        <h3>
          ?. Créez un formulaire d'upload
        </h3>
        <div class="screenshot-left" style="margin-right: 25px;">
        	<img  src="images/scrshot_formulaire_envoie.png" width="350px"/>
        </div>
        <div style="margin-top:20px;">
        <p>Balise &lt;input type="file" /&gt;</p>
        <p>Envoyez le formulaire avec la méthode POST et type d'encodage multipart/form-data</p>
        <p>L'url d'envoi du formulaire nous est donné par App Engine</p>
<pre>
BlobstoreService blobservice = BlobstoreServiceFactory
	.getBlobstoreService();
blobservice.createUploadUrl("/upload");
</pre>
        </div>
      </article>

<!-- ------------------------------------------------------------------------------- -->
<!-- Servlet d'enregistrement -->      
      <article id="art31" onclick="move('art31')" class="slide3d" > 
      <div class="backslide3d">
<p>fichier: admin.jsp</p>
<pre class="smallcode lesspace">
package com.moi.lepresident;
import java.io.IOException;
import java.util.*;
import javax.servlet.ServletException;
import javax.servlet.http.*;
import com.google.appengine.api.blobstore.*;
import com.google.appengine.api.images.ImagesServiceFactory;
import com.googlecode.objectify.ObjectifyService;

public class UploadServlet extends HttpServlet {
	@Override
	protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		Map<String, List<BlobKey>> blobs = 
			BlobstoreServiceFactory.getBlobstoreService().getUploads(req);
		President president = new President();
		president.image = ImagesServiceFactory.getImagesService()
			.getServingUrl(blobs.get("image").get(0));
		president.name = req.getParameter("name");
		ObjectifyService.begin().put(president);
		resp.sendRedirect("/");
	}
}
</pre>
<p>Ne pas oublier d'ajouter la servlet dans le fichier web.xml</p>
      </div>
        <h3>
          ?. Créez la servlet d'enregistrement
        </h3>
        
        <div style="margin-top:15px;">
        <p>Créez une servlet qui s'occupera de sauvegarder les données du formulaire</p>
        <p>Récupérez la clé de l'image dans le blobstore</p>
<pre class="lesspace">
BlobstoreService blobservice = BlobstoreServiceFactory
	.getBlobstoreService();
Map&lt;String, List&lt;BlobKey&gt;&gt; blobs = blobservice.getUploads(req);
BlobKey key = blobs.get("image").get(0);
</pre>
        <p>Générer l'url de l'image grâce à imageService</p>
<pre class="lesspace">
ImagesServiceFactory.getImagesService().getServingUrl(key);
</pre>
<p>N'oubliez pas de changer la tâche planifié !</p>
        </div>
      </article>
 
 
 <!-- slide : deployer -->
      <article id="title11"> 
      		<h2>Yakakliker...</h2>
      		<p>Deployer sur App Engine</p>
      </article>

      <article id="artTitle11" onclick="move('artTitle11')" class="slide3d" > 
      <div class="backslide3d">
      
<p>fichier: war/WEB-INF/appengine-web.xml</p>
<pre class="smallcode lesspace">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;appengine-web-app xmlns=&quot;http://appengine.google.com/ns/1.0&quot;&gt;
    &lt;!-- Le nom de votre ApplicationId sur http://appengine.google.com --&gt;
  &lt;application&gt;lepresidentest&lt;/application&gt;Deployer sur App Engine
  &lt;!-- Version de votre application, cela peut etre un texte (alpha, beta, etc...) --&gt;
  &lt;version&gt;1&lt;/version&gt;
  ...
  
&lt;/appengine-web-app&gt;
  
</pre>

      </div>
        <h3>
          Deployer sur App Engine
        </h3>
        <ul>
         <li>Créer un identifiant pour votre application sur <a href="http://appengine.google.com" target="_blank">http://appengine.google.com/</a></li>
         <li>Configuer le projet via le fichier appengine-web.xml : en mettant l'identifiant de l'application, un numero de version.</li>
         <li>Cliquer sur déployer...</li>
        </ul>

        <div style="margin-top:20px;">
<img height="200px;" src="images/deployer.png" style="vertical-align: -30%"/>        
        </div>
        
      </article>

<!-- ------------------------------------------------------------------------------- -->

 
<!-- slide finale: chrome -->
      <article>
        
        <p style="text-align: center; font-size: 4em; margin-top: 160px; color: #777777">
        <img height="200px;" src="images/chrome.png" style="vertical-align: -30%"/> chrome
        </p>
        
      </article>
<!-- ------------------------------------------------------------------------------- -->
<!-- slide finale: contact info -->
      <article>
        
        <p style="margin-left: 3em; margin-top: 1em; text-indent: -2em;">Contact : <br/><b >+Martin Gorner</b>, Outreach manager France
        (et les autres ...)
        </p>
        <p style="margin-left: 3em; margin-top: 1.5em; text-indent: -2em;">Cette présentation est en ligne :<br/>
        <a href="http://electionfr2012.appspot.com">http://<b><span class="big">electionfr2012</span></b>.appspot.com</a><br/>
        <p style="margin-left: 3em; margin-top: 1.5em; text-indent: -2em;">Code source :<br/>
        <a href="http://code.google.com/p/devoxx-france-appengine/">http://code.google.com/p/<b><span class="big">devoxx-france-appengine</span></b>/</a><br/>
        <p style="margin-left: 3em; margin-top: 1.5em; text-indent: -2em;">Plus d'infos :<br/>
        <a href="http://developers.google.com/appengine/">http://developers.google.com/<b><span class="big">appengine</span></b></a>
        </p>
        
      </article>

    </section>


  </body>
</html>
